<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Browser - OpenEndpoint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.468.0/font/lucide.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                        success: {
                            DEFAULT: "hsl(142 70% 45%)",
                            foreground: "hsl(142 70% 95%)",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --background: 222 47% 6%;
            --foreground: 210 40% 98%;
            --card: 222 47% 8%;
            --card-foreground: 210 40% 98%;
            --primary: 212 100% 50%;
            --primary-foreground: 210 40% 98%;
            --secondary: 217 33% 17%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217 33% 17%;
            --muted-foreground: 215 20% 65%;
            --accent: 217 33% 17%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 84% 50%;
            --destructive-foreground: 210 40% 98%;
            --border: 217 33% 17%;
            --input: 217 33% 17%;
            --ring: 212 100% 50%;
            --radius: 0.5rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #0a0a0a;
            color: #fafafa;
            min-height: 100vh;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #171717; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        .glass {
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .sidebar {
            background: linear-gradient(180deg, #0f0f0f 0%, #0a0a0a 100%);
            border-right: 1px solid #27272a;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: 0.5rem;
            color: #a1a1aa;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s ease;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: #fafafa;
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s ease;
            cursor: pointer;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #27272a;
            color: #fafafa;
            border: 1px solid #3f3f46;
        }

        .btn-secondary:hover {
            background: #3f3f46;
        }

        .btn-ghost {
            background: transparent;
            color: #a1a1aa;
        }

        .btn-ghost:hover {
            background: rgba(255,255,255,0.05);
            color: #fafafa;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 0.5rem;
            color: #fafafa;
            font-size: 0.875rem;
            transition: all 0.15s ease;
        }

        .input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.2);
        }

        .input::placeholder {
            color: #71717a;
        }

        .table-container {
            border: 1px solid #27272a;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #18181b;
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #27272a;
        }

        td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid #27272a;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .bucket-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .bucket-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .bucket-item.active {
            background: rgba(59, 130, 246, 0.15);
        }

        .drop-zone {
            border: 2px dashed #3f3f46;
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 28rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid #27272a;
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-footer {
            padding: 1.25rem;
            border-top: 1px solid #27272a;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 100;
            animation: slideIn 0.2s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .icon {
            width: 1rem;
            height: 1rem;
        }

        .icon-lg {
            width: 1.25rem;
            height: 1.25rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }

        .breadcrumb-item {
            color: #71717a;
            cursor: pointer;
        }

        .breadcrumb-item:hover {
            color: #fafafa;
        }

        .breadcrumb-separator {
            color: #3f3f46;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .empty-state-icon {
            width: 4rem;
            height: 4rem;
            margin-bottom: 1rem;
            color: #3f3f46;
        }

        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid #27272a;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-blue {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .badge-green {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .badge-red {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.375rem 0.625rem;
            background: #27272a;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        .progress-bar {
            height: 0.5rem;
            background: #27272a;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 9999px;
            transition: width 0.3s ease;
        }

        .object-row {
            cursor: pointer;
        }

        .object-row:hover {
            background: rgba(59, 130, 246, 0.05) !important;
        }
    </style>
</head>
<body class="antialiased">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="sidebar w-64 flex flex-col">
            <!-- Logo -->
            <div class="p-4 border-b border-zinc-800">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <span class="text-white font-bold text-sm">OE</span>
                    </div>
                    <div>
                        <h1 class="font-semibold text-white">OpenEndpoint</h1>
                        <p class="text-xs text-zinc-500">S3 Compatible Storage</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="p-3 space-y-1">
                <a href="/_dashboard/" class="nav-item">
                    <i data-lucide="layout-dashboard" class="icon-lg"></i>
                    Dashboard
                </a>
                <a href="/_dashboard/browser" class="nav-item active">
                    <i data-lucide="box" class="icon-lg"></i>
                    S3 Browser
                </a>
                <a href="/_dashboard/metrics" class="nav-item">
                    <i data-lucide="bar-chart-3" class="icon-lg"></i>
                    Metrics
                </a>
                <a href="/_dashboard/cluster" class="nav-item">
                    <i data-lucide="network" class="icon-lg"></i>
                    Cluster
                </a>
                <a href="/_mgmt/" class="nav-item">
                    <i data-lucide="code" class="icon-lg"></i>
                    API
                </a>
            </nav>

            <!-- Buckets List -->
            <div class="flex-1 overflow-y-auto p-3 border-t border-zinc-800">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-semibold text-zinc-500 uppercase tracking-wider">Buckets</h3>
                    <button onclick="showCreateBucketModal()" class="p-1 rounded hover:bg-zinc-800 text-zinc-400 hover:text-white transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>
                <div id="buckets-list" class="space-y-1">
                    <div class="text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        <p class="text-xs text-zinc-500">Loading buckets...</p>
                    </div>
                </div>
            </div>

            <!-- Storage Info -->
            <div class="p-4 border-t border-zinc-800">
                <div class="space-y-2">
                    <div class="flex justify-between text-xs">
                        <span class="text-zinc-500">Storage Used</span>
                        <span class="text-zinc-400" id="storage-used">--</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="h-14 border-b border-zinc-800 flex items-center justify-between px-6 bg-zinc-950/50">
                <div class="flex items-center gap-4">
                    <h2 class="text-lg font-semibold text-white" id="current-bucket">Select a bucket</h2>
                    <div class="breadcrumb" id="breadcrumb"></div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Search -->
                    <div class="relative" id="search-container" style="display: none;">
                        <input type="text" id="object-search"
                            class="w-48 px-3 py-1.5 pl-8 bg-zinc-800 border border-zinc-700 rounded-lg text-sm text-white placeholder-zinc-500 focus:outline-none focus:border-blue-500"
                            placeholder="Filter objects..." oninput="filterObjects(this.value)">
                        <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                    <button onclick="refreshObjects()" class="btn btn-ghost">
                        <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                    </button>
                    <button onclick="showUploadModal()" id="upload-btn" class="btn btn-primary" style="display: none;">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        Upload
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="flex-1 overflow-auto p-6">
                <!-- Upload Zone -->
                <div id="upload-zone" class="mb-6" style="display: none;">
                    <div class="drop-zone" id="drop-zone">
                        <i data-lucide="cloud-upload" class="w-12 h-12 mx-auto mb-3 text-zinc-500"></i>
                        <p class="text-zinc-400 mb-1">Drop files here or click to upload</p>
                        <p class="text-xs text-zinc-600">Maximum file size: 10MB</p>
                        <input type="file" id="file-input" class="hidden" multiple>
                    </div>
                </div>

                <!-- Objects Table -->
                <div class="table-container" id="objects-container">
                    <div class="empty-state" id="empty-state">
                        <i data-lucide="folder-open" class="empty-state-icon"></i>
                        <h3 class="text-lg font-medium text-white mb-1">No bucket selected</h3>
                        <p class="text-zinc-500 mb-4">Select a bucket from the sidebar to view its contents</p>
                    </div>
                    <table id="objects-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Last Modified</th>
                                <th>Storage Class</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="objects-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Bucket Modal -->
    <div id="create-bucket-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="text-lg font-semibold text-white">Create New Bucket</h3>
            </div>
            <div class="modal-body">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-zinc-400 mb-2">Bucket Name</label>
                        <input type="text" id="bucket-name-input" class="input" placeholder="my-bucket">
                        <p class="text-xs text-zinc-500 mt-2">Bucket names must be unique and DNS-compliant</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeCreateBucketModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="createBucket()" class="btn btn-primary">Create Bucket</button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="text-lg font-semibold text-white">Upload Files</h3>
            </div>
            <div class="modal-body">
                <div class="drop-zone" id="upload-drop-zone">
                    <i data-lucide="cloud-upload" class="w-12 h-12 mx-auto mb-3 text-zinc-500"></i>
                    <p class="text-zinc-400 mb-1">Drop files here or click to select</p>
                    <p class="text-xs text-zinc-600">Maximum file size: 10MB</p>
                    <input type="file" id="upload-file-input" class="hidden" multiple>
                </div>
                <div id="upload-progress" class="mt-4 space-y-2"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeUploadModal()" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="text-lg font-semibold text-white" id="delete-title">Confirm Delete</h3>
            </div>
            <div class="modal-body">
                <p class="text-zinc-400" id="delete-message">Are you sure you want to delete this item?</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="confirmDelete()" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 48rem;">
            <div class="modal-header flex items-center justify-between">
                <h3 class="text-lg font-semibold text-white" id="preview-title">Preview</h3>
                <button onclick="closePreviewModal()" class="btn btn-ghost p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="preview-content" class="bg-zinc-900 rounded-lg p-4 min-h-48 max-h-96 overflow-auto">
                    <div class="flex items-center justify-center h-48 text-zinc-500">
                        <div class="text-center">
                            <div class="spinner mx-auto mb-2"></div>
                            <p>Loading preview...</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex items-center justify-between text-sm">
                    <span class="text-zinc-500" id="preview-info"></span>
                    <div class="flex gap-2">
                        <button onclick="downloadCurrentPreview()" class="btn btn-secondary text-sm">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" style="display: none;"></div>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        lucide.createIcons();

        let currentBucket = null;
        let currentPrefix = '';
        let deleteTarget = null;
        let allObjects = [];  // Store all objects for filtering
        let allPrefixes = []; // Store all prefixes for filtering

        // Initialize
        loadBuckets();

        // Check URL for bucket parameter
        const urlParams = new URLSearchParams(window.location.search);
        const urlBucket = urlParams.get('bucket');
        if (urlBucket) {
            setTimeout(() => navigateToBucket(urlBucket), 500);
        }

        async function loadBuckets() {
            const container = document.getElementById('buckets-list');
            try {
                const response = await fetch('/_mgmt/buckets');
                const data = await response.json();
                const buckets = data.buckets || [];

                if (buckets.length === 0) {
                    container.innerHTML = `
                        <p class="text-xs text-zinc-500 text-center py-4">No buckets yet</p>
                    `;
                    return;
                }

                container.innerHTML = buckets.map(bucket => `
                    <div class="bucket-item group ${currentBucket === bucket.Name ? 'active' : ''}"
                         onclick="navigateToBucket('${bucket.Name}')">
                        <i data-lucide="folder" class="w-4 h-4 text-zinc-500"></i>
                        <span class="flex-1 truncate text-sm">${bucket.Name}</span>
                        <button onclick="event.stopPropagation(); deleteBucket('${bucket.Name}')"
                                class="p-1 rounded opacity-0 group-hover:opacity-100 hover:bg-zinc-800 text-zinc-500 hover:text-red-400 transition-all">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch (error) {
                container.innerHTML = `<p class="text-xs text-red-400 text-center py-4">Failed to load</p>`;
            }
        }

        function navigateToBucket(bucket) {
            currentBucket = bucket;
            currentPrefix = '';
            allObjects = [];
            allPrefixes = [];

            // Update UI
            document.getElementById('current-bucket').textContent = bucket || 'Select a bucket';
            document.getElementById('upload-btn').style.display = bucket ? 'flex' : 'none';
            document.getElementById('upload-zone').style.display = bucket ? 'block' : 'none';
            document.getElementById('search-container').style.display = bucket ? 'block' : 'none';

            // Clear search
            document.getElementById('object-search').value = '';

            // Update breadcrumb
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = bucket
                ? `<span class="breadcrumb-item" onclick="navigateToBucket(null)">Buckets</span><span class="breadcrumb-separator">/</span><span class="text-white">${bucket}</span>`
                : '';

            if (bucket) {
                loadObjects(bucket, '');
                loadBuckets(); // Refresh sidebar
            } else {
                document.getElementById('empty-state').style.display = 'flex';
                document.getElementById('objects-table').style.display = 'none';
            }
        }

        async function loadObjects(bucket, prefix) {
            const emptyState = document.getElementById('empty-state');
            const objectsTable = document.getElementById('objects-table');

            emptyState.innerHTML = `
                <div class="spinner mx-auto mb-3"></div>
                <p class="text-zinc-500">Loading objects...</p>
            `;
            emptyState.style.display = 'flex';
            objectsTable.style.display = 'none';

            try {
                let url = `/_mgmt/buckets/${bucket}/objects?delimiter=/`;
                if (prefix) url += `&prefix=${encodeURIComponent(prefix)}`;

                const response = await fetch(url);
                const data = await response.json();

                const prefixes = data.CommonPrefixes || [];
                const objects = data.Contents || [];

                // Store for filtering
                allPrefixes = prefixes;
                allObjects = objects;

                if (prefixes.length === 0 && objects.length === 0) {
                    emptyState.innerHTML = `
                        <i data-lucide="folder-open" class="empty-state-icon"></i>
                        <h3 class="text-lg font-medium text-white mb-1">No objects</h3>
                        <p class="text-zinc-500">This bucket is empty. Upload files to get started.</p>
                    `;
                    lucide.createIcons();
                    return;
                }

                emptyState.style.display = 'none';
                objectsTable.style.display = 'table';

                // Use the shared render function
                renderObjects(prefixes, objects);
            } catch (error) {
                emptyState.innerHTML = `
                    <i data-lucide="alert-circle" class="empty-state-icon text-red-400"></i>
                    <h3 class="text-lg font-medium text-white mb-1">Error</h3>
                    <p class="text-zinc-500">${error.message}</p>
                `;
                lucide.createIcons();
            }
        }

        function navigateToFolder(prefix) {
            currentPrefix = prefix;
            const folderName = prefix.split('/').slice(-2)[0];

            // Update breadcrumb
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = `
                <span class="breadcrumb-item" onclick="navigateToBucket(null)">Buckets</span>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item" onclick="navigateToBucket('${currentBucket}')">${currentBucket}</span>
                <span class="breadcrumb-separator">/</span>
                <span class="text-white">${folderName}</span>
            `;

            loadObjects(currentBucket, prefix);
        }

        function refreshObjects() {
            if (currentBucket) {
                loadObjects(currentBucket, currentPrefix);
            }
        }

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Filter objects by search query
        function filterObjects(query) {
            const emptyState = document.getElementById('empty-state');
            const objectsTable = document.getElementById('objects-table');

            if (!query) {
                // Show all objects
                renderObjects(allPrefixes, allObjects);
                return;
            }

            const lowerQuery = query.toLowerCase();

            // Filter prefixes
            const filteredPrefixes = allPrefixes.filter(p =>
                p.Prefix.toLowerCase().includes(lowerQuery)
            );

            // Filter objects
            const filteredObjects = allObjects.filter(obj =>
                obj.Key.toLowerCase().includes(lowerQuery)
            );

            if (filteredPrefixes.length === 0 && filteredObjects.length === 0) {
                emptyState.innerHTML = `
                    <i data-lucide="search-x" class="empty-state-icon"></i>
                    <h3 class="text-lg font-medium text-white mb-1">No results</h3>
                    <p class="text-zinc-500">No objects match "${query}"</p>
                `;
                lucide.createIcons();
                emptyState.style.display = 'flex';
                objectsTable.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                objectsTable.style.display = 'table';
                renderObjects(filteredPrefixes, filteredObjects);
            }
        }

        // Render objects (refactored for reuse)
        function renderObjects(prefixes, objects) {
            let html = '';

            // Folders
            prefixes.forEach(p => {
                const folderName = p.Prefix.split('/').slice(-2)[0];
                html += `
                    <tr class="object-row" onclick="navigateToFolder('${p.Prefix}')">
                        <td>
                            <div class="flex items-center gap-3">
                                <i data-lucide="folder" class="w-5 h-5 text-blue-400"></i>
                                <span class="font-medium text-white">${folderName}/</span>
                            </div>
                        </td>
                        <td class="text-zinc-500">-</td>
                        <td class="text-zinc-500">-</td>
                        <td><span class="badge badge-blue">Folder</span></td>
                        <td class="text-right"></td>
                    </tr>
                `;
            });

            // Objects
            objects.forEach(obj => {
                const key = obj.Key;
                const name = key.split('/').pop();
                const size = formatBytes(obj.Size);
                const modified = obj.LastModified ? new Date(obj.LastModified).toLocaleDateString() : '-';

                html += `
                    <tr class="object-row">
                        <td>
                            <div class="flex items-center gap-3">
                                <i data-lucide="file" class="w-5 h-5 text-zinc-500"></i>
                                <span class="font-medium text-white">${name}</span>
                            </div>
                        </td>
                        <td class="text-zinc-400 font-mono text-sm">${size}</td>
                        <td class="text-zinc-500">${modified}</td>
                        <td><span class="badge badge-green">STANDARD</span></td>
                        <td class="text-right">
                                <div class="flex items-center justify-end gap-1">
                                    <button onclick="event.stopPropagation(); previewObject('${currentBucket}', '${key}')"
                                            class="p-1.5 rounded hover:bg-zinc-800 text-zinc-400 hover:text-white transition-colors" title="Preview">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); downloadObject('${currentBucket}', '${key}')"
                                            class="p-1.5 rounded hover:bg-zinc-800 text-zinc-400 hover:text-white transition-colors" title="Download">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); copyUrl('${currentBucket}', '${key}')"
                                            class="p-1.5 rounded hover:bg-zinc-800 text-zinc-400 hover:text-white transition-colors" title="Copy URL">
                                        <i data-lucide="link" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteObject('${key}')"
                                            class="p-1.5 rounded hover:bg-zinc-800 text-zinc-400 hover:text-red-400 transition-colors" title="Delete">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </td>
                    </tr>
                `;
            });

            document.getElementById('objects-body').innerHTML = html;
            lucide.createIcons();
        }

        function downloadObject(bucket, key) {
            window.open(`/s3/${bucket}/${key}`, '_blank');
        }

        function copyUrl(bucket, key) {
            const url = `${window.location.origin}/s3/${bucket}/${key}`;
            navigator.clipboard.writeText(url);
            showToast('URL copied to clipboard', 'success');
        }

        // Preview functions
        let currentPreviewKey = null;

        async function previewObject(bucket, key) {
            currentPreviewKey = key;
            const modal = document.getElementById('preview-modal');
            const title = document.getElementById('preview-title');
            const content = document.getElementById('preview-content');
            const info = document.getElementById('preview-info');

            title.textContent = key.split('/').pop();
            content.innerHTML = `
                <div class="flex items-center justify-center h-48 text-zinc-500">
                    <div class="text-center">
                        <div class="spinner mx-auto mb-2"></div>
                        <p>Loading preview...</p>
                    </div>
                </div>
            `;
            info.textContent = '';
            modal.style.display = 'flex';
            lucide.createIcons();

            try {
                const response = await fetch(`/_mgmt/buckets/${bucket}/objects/${encodeURIComponent(key)}`);
                if (!response.ok) throw new Error('Failed to load object');

                const blob = await response.blob();
                const contentType = blob.type;
                const size = formatBytes(blob.size);

                info.textContent = `${contentType || 'Unknown type'} - ${size}`;

                // Check if it's an image
                if (contentType.startsWith('image/')) {
                    const url = URL.createObjectURL(blob);
                    content.innerHTML = `<img src="${url}" class="max-w-full max-h-80 mx-auto rounded" alt="${key}">`;
                }
                // Check if it's text
                else if (contentType.startsWith('text/') || contentType === 'application/json' || contentType === 'application/javascript') {
                    const text = await blob.text();
                    const truncated = text.length > 50000 ? text.substring(0, 50000) + '...' : text;
                    content.innerHTML = `<pre class="text-sm text-zinc-300 whitespace-pre-wrap font-mono">${escapeHtml(truncated)}</pre>`;
                }
                // PDF
                else if (contentType === 'application/pdf') {
                    const url = URL.createObjectURL(blob);
                    content.innerHTML = `<iframe src="${url}" class="w-full h-80 rounded" ></iframe>`;
                }
                // Other files
                else {
                    content.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-48 text-zinc-500">
                            <i data-lucide="file-text" class="w-16 h-16 mb-4"></i>
                            <p class="text-lg font-medium">${contentType || 'Unknown file type'}</p>
                            <p class="text-sm mt-2">Preview not available for this file type</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-48 text-red-400">
                        <i data-lucide="alert-circle" class="w-12 h-12 mb-2"></i>
                        <p>Error loading preview</p>
                        <p class="text-sm text-zinc-500 mt-1">${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function closePreviewModal() {
            document.getElementById('preview-modal').style.display = 'none';
            currentPreviewKey = null;
        }

        function downloadCurrentPreview() {
            if (currentPreviewKey && currentBucket) {
                downloadObject(currentBucket, currentPreviewKey);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal functions
        function showCreateBucketModal() {
            document.getElementById('create-bucket-modal').style.display = 'flex';
            document.getElementById('bucket-name-input').focus();
        }

        function closeCreateBucketModal() {
            document.getElementById('create-bucket-modal').style.display = 'none';
            document.getElementById('bucket-name-input').value = '';
        }

        async function createBucket() {
            const name = document.getElementById('bucket-name-input').value.trim().toLowerCase();
            if (!name) {
                showToast('Please enter a bucket name', 'error');
                return;
            }

            try {
                const response = await fetch('/_mgmt/buckets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create bucket');
                }

                closeCreateBucketModal();
                showToast('Bucket created successfully', 'success');
                loadBuckets();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function showUploadModal() {
            document.getElementById('upload-modal').style.display = 'flex';
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').style.display = 'none';
            document.getElementById('upload-progress').innerHTML = '';
        }

        function deleteBucket(bucket) {
            deleteTarget = { type: 'bucket', bucket };
            document.getElementById('delete-title').textContent = 'Delete Bucket';
            document.getElementById('delete-message').textContent = `Are you sure you want to delete bucket "${bucket}"? All objects will be permanently deleted.`;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function deleteObject(key) {
            deleteTarget = { type: 'object', key };
            document.getElementById('delete-title').textContent = 'Delete Object';
            document.getElementById('delete-message').textContent = `Are you sure you want to delete "${key}"?`;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            deleteTarget = null;
        }

        async function confirmDelete() {
            if (!deleteTarget) return;

            try {
                if (deleteTarget.type === 'bucket') {
                    const response = await fetch(`/_mgmt/buckets/${deleteTarget.bucket}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to delete bucket');
                    }
                    showToast('Bucket deleted', 'success');
                    if (currentBucket === deleteTarget.bucket) {
                        navigateToBucket(null);
                    }
                    loadBuckets();
                } else {
                    const response = await fetch(`/_mgmt/buckets/${currentBucket}/objects/${encodeURIComponent(deleteTarget.key)}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to delete object');
                    }
                    showToast('Object deleted', 'success');
                    refreshObjects();
                }
            } catch (error) {
                showToast(error.message, 'error');
            }

            closeDeleteModal();
        }

        // File upload
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadDropZone = document.getElementById('upload-drop-zone');
        const uploadFileInput = document.getElementById('upload-file-input');

        function setupDropZone(dropZoneEl, inputEl, handler) {
            dropZoneEl.addEventListener('click', () => inputEl.click());
            dropZoneEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZoneEl.classList.add('dragover');
            });
            dropZoneEl.addEventListener('dragleave', () => {
                dropZoneEl.classList.remove('dragover');
            });
            dropZoneEl.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZoneEl.classList.remove('dragover');
                handler(e.dataTransfer.files);
            });
            inputEl.addEventListener('change', (e) => {
                handler(e.target.files);
            });
        }

        setupDropZone(dropZone, fileInput, handleFiles);
        setupDropZone(uploadDropZone, uploadFileInput, handleFiles);

        async function handleFiles(files) {
            if (!currentBucket) {
                showToast('Please select a bucket first', 'error');
                return;
            }

            const progressContainer = document.getElementById('upload-progress');
            progressContainer.innerHTML = '';

            for (const file of files) {
                const progressEl = document.createElement('div');
                progressEl.className = 'flex items-center gap-2 text-sm';
                progressEl.innerHTML = `
                    <span class="text-zinc-400 truncate flex-1">${file.name}</span>
                    <div class="spinner w-4 h-4"></div>
                `;
                progressContainer.appendChild(progressEl);

                await uploadFile(file);
                progressEl.innerHTML = `
                    <i data-lucide="check" class="w-4 h-4 text-green-400"></i>
                    <span class="text-green-400">${file.name}</span>
                `;
            }

            lucide.createIcons();
            refreshObjects();
            showToast(`Uploaded ${files.length} file(s)`, 'success');
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('key', currentPrefix + file.name);

            const response = await fetch(`/_mgmt/buckets/${currentBucket}/objects`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to upload');
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast bg-${type === 'success' ? 'green-600' : 'red-600'}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeCreateBucketModal();
                closeDeleteModal();
                closeUploadModal();
                closePreviewModal();
            }
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                refreshObjects();
            }
        });
    </script>
</body>
</html>
